name: SonarQube Analysis

# DISABLED: Using SonarCloud instead of local SonarQube
# on:
#   push:
#     branches: [ main, develop ]
#   pull_request:
#     branches: [ main ]
on:
  workflow_dispatch:  # Only manual execution

jobs:
  sonarqube-analysis:
    name: SonarQube Analysis
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_USER: sonar
          POSTGRES_PASSWORD: sonar
          POSTGRES_DB: sonar
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Shallow clones should be disabled for better analysis

    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'

    - name: Install dependencies
      run: flutter pub get

    - name: Run tests
      run: flutter test --coverage

    - name: Start SonarQube
      run: |
        docker run -d --name sonarqube \
          -p 9000:9000 \
          -e SONAR_JDBC_URL=jdbc:postgresql://localhost:5432/sonar \
          -e SONAR_JDBC_USERNAME=sonar \
          -e SONAR_JDBC_PASSWORD=sonar \
          sonarqube:lts
        
        # Wait for SonarQube to be ready
        timeout 300 bash -c 'until curl -f http://localhost:9000/api/system/status; do sleep 5; done'

    - name: Generate SonarQube token
      run: |
        TOKEN=$(curl -u admin:admin -X POST "http://localhost:9000/api/user_tokens/generate?name=github-action-token&type=GLOBAL_ANALYSIS_TOKEN" | jq -r '.token')
        echo "SONAR_TOKEN=$TOKEN" >> $GITHUB_ENV

    - name: Download SonarScanner
      run: |
        wget https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip
        unzip sonar-scanner-cli-5.0.1.3006-linux.zip
        sudo mv sonar-scanner-5.0.1.3006-linux /opt/sonar-scanner
        sudo ln -sf /opt/sonar-scanner/bin/sonar-scanner /usr/local/bin/

    - name: Run SonarQube analysis
      run: |
        sonar-scanner \
          -Dsonar.host.url=http://localhost:9000 \
          -Dsonar.login=${{ env.SONAR_TOKEN }} \
          -Dsonar.projectKey=temposage-movil \
          -Dsonar.projectName=TempoSage Movil \
          -Dsonar.projectVersion=1.0.0 \
          -Dsonar.sources=lib \
          -Dsonar.tests=test \
          -Dsonar.coverageReportPaths=coverage/lcov.info \
          -Dsonar.dart.analyzer.reportPaths=analysis-report.txt \
          -Dsonar.exclusions=**/*.g.dart,**/*.freezed.dart,**/*.mocks.dart,**/*.gr.dart,**/*.chopper.dart,**/generated/**,**/build/**,**/.dart_tool/**,**/*.md,**/docs/**,**/*.json,**/*.yaml,**/*.yml,**/*.lock,**/*.txt,**/*.csv,**/*.pickle,**/performance_reports/**,**/test-reports/**,**/coverage/**,**/web/**,**/ios/**,**/android/**,**/linux/**,**/macos/**,**/windows/**,**/.github/**,**/sonar-plugins/**,**/ollama_proxy/**,**/data/**,**/assets/**,**/*.xml,**/*.properties,**/*.toml,**/*.sh,**/*.py,**/*.jar,**/*.pdf,**/*.jpg,**/*.png,**/*.gif,**/*.svg,**/*.ico,**/*.ttf,**/*.otf

    - name: Get Quality Gate status
      run: |
        curl -u admin:admin "http://localhost:9000/api/qualitygates/project_status?projectKey=temposage-movil" | jq '.'
        
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage/lcov.info
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

    - name: Comment PR with SonarQube results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          const botComment = comments.find(comment => 
            comment.user.type === 'Bot' && comment.body.includes('SonarQube Analysis')
          );
          
          const commentBody = `
          ## üîç SonarQube Analysis Results
          
          **Project:** TempoSageMovil  
          **Branch:** ${context.payload.pull_request.head.ref}  
          **Commit:** ${context.payload.pull_request.head.sha.substring(0, 7)}  
          
          ### üìä Quality Gate Status
          - **Status:** ‚úÖ PASSED / ‚ùå FAILED
          - **Coverage:** Check dashboard for details
          - **Issues:** See full report in SonarQube
          
          ### üîó Links
          - [SonarQube Dashboard](http://localhost:9000/dashboard?id=temposage-movil)
          - [Quality Gate Details](http://localhost:9000/quality_gates/show/temposage-movil)
          
          ---
          *This comment was automatically generated by SonarQube Analysis*
          `;
          
          if (botComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: commentBody
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: commentBody
            });
          }

    - name: Stop SonarQube
      if: always()
      run: docker stop sonarqube || true
